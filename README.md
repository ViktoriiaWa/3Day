# 3Day

Краткое описание
Объект исследования: Виртуальная машина под названием "3 Day", подвергшаяся атаке. В результате проведенного анализа были выявлены следы проникновения злоумышленника, который использовал root-доступ и другие средства для закрепления и маскировки своих действий. Проводя это исследование, я сосредоточилась на том, чтобы восстановить картину атаки, выявить методы злоумышленника и наметить пути защиты системы.
Цель:
Выявить все следы присутствия злоумышленника.
Подробно проанализировать его действия.
Очистить систему и подготовить рекомендации для усиления безопасности.

Шаги анализа и выявленная информация
Шаг 1: Получение доступа к системе
В самом начале я занялась загрузчиком GRUB, поскольку с его помощью можно обойти некоторые ограничения. Перейдя в меню дополнительных параметров, я изменила загрузочную строку, что позволило мне подойти к системе с новым уровнем прав.
Действие: Модификация строки загрузки.
Результат: Успешный доступ к системе после подбора пароля.
Скриншот: Окно загрузчика GRUB и модифицированная загрузочная строка.

Шаг 2: Сетевое сканирование и анализ подключения
Чтобы понять, каким образом злоумышленник проникал в систему, я провела сканирование сети. Подключив виртуальную машину к Kali Linux, я использовала Nmap для поиска активных портов.
Действие: Сканирование сети через Nmap.
Результат: Обнаружен нестандартный SSH-порт, который мог быть использован для скрытного подключения.

Настроив параметры SSH, я подключилась к системе, чтобы изучить её состояние изнутри. Это помогло подтвердить мои подозрения о возможных брутфорс-атаках и других методах проникновения.

Конфигурация SSH перед подключением (файл /etc/ssh/sshd_config).

Шаг 3: Анализ логов системы
Я обратилась к логам в папке /var/log, чтобы найти команды и следы, оставленные атакующим.
Действие: Просмотр auth.log, syslog и nginx.
Результат: Обнаружены попытки подключения с IP 85.140.1.102, а также команды для очистки логов, что является явным указанием на сокрытие следов.
Дополнительная информация: Атакующий регулярно подключался с использованием этих данных и повышал свои привилегии до root.

Адрес атакующего: 85.140.1.102. Первое подключение по SSH произошло 23 мая в 01:06:36, когда наблюдается множество неудачных попыток аутентификации для пользователя admin. Однако позже пароль был успешно подобран, и сессия была открыта для пользователя admin через порт 22201.После успешного входа, пользователь admin сразу выполняет команду su, чтобы получить root-доступ, что указывает на эскалацию привилегий. Успешное выполнение команды su подтверждается строками, где admin становится root.
Атакующий несколько раз повторно подключался к системе, используя тот же IP-адрес, порт и логин admin, и каждый раз проводил действия с эскалацией привилегий. Пароль от admin являлся именем учетной записи.

Также были команды, связанные с docker_admin, который пытался удалить историю команд с помощью rm -f .bash_history, что говорит о попытке скрыть следы​.

Атакующий несколько раз повторно подключался к системе, используя тот же IP-адрес, порт и логин admin, и каждый раз проводил действия с эскалацией привилегий.
23 мая в 01:09:02 видно использование команды sudo для выполнения tail -f nohup.out, вероятней, для мониторинга выходных данных или логов, что может указывать на попытки следить за запущенными процессами или файлами.


Адрес 85.140.1.102 предпринимал множество параллельных попыток подбора пароля для пользователя docker_admin, он несколько раз превышал максимальное число попыток и был отключен, но затем сразу пытался снова, что свидетельствует о брутфорс-атаке. 

Логи содержат записи о том, что root открывал и закрывал задания cron. Это может указывать на то, что злоумышленник использовал cron для создания запланированных задач, которые могли запускать вредоносные скрипты через определенные интервалы времени
Шаг 4: Анализ Cron-заданий
Для того чтобы выявить автоматические действия злоумышленника, я обратилась к заданиям Cron. Было обнаружено задание, запускающее скрипт avahi при каждой перезагрузке.
Действие: Проверка Cron для root-пользователя.
Результат: Удаление подозрительного задания, чтобы предотвратить повторный запуск вредоносного скрипта.
Cкрипт avahi использовался для загрузки руткита diamorphine.ko, который внедрялся в ядро. Это дало мне ключ к пониманию методики сохранения доступа и контроля системы.
Скриншот: Cron-задания с подозрительными записями.

Шаг 5: Анализ временных файлов и скриптов
В процессе анализа временных файлов я обратила внимание на скрипт, расположенный в директории /tmp/N3M3S1S_folder, который, судя по названию, использовался для временного хранения и запуска вредоносных команд.
На скриншоте показано содержимое файла под названием drop, который содержит следующую последовательность команд:
Создание временной директории /tmp/N3M3S1S_folder для хранения загружаемых файлов.
Переход в эту директорию.
Загрузка файла bot с удаленного сервера 37.46.128.71, который, скорее всего, представляет собой вредоносный компонент.
Загрузка руткита diamorphine.ko с того же удаленного сервера. Этот модуль внедряется в ядро Linux, чтобы скрыть активность злоумышленника.
Команда insmod загружает diamorphine.ko в ядро, позволяя злоумышленнику скрыть свои процессы и повысить уровень привилегий.
Настройка прав для файла bot и его запуск.
Этот скрипт предоставляет подробную информацию о шагах, предпринятых злоумышленником для установки вредоносного ПО и руткита. Скриншот наглядно демонстрирует команды, которые позволили злоумышленнику автоматизировать загрузку и установку вредоносного ПО, что подтверждает его попытки закрепиться в системе и скрыть свою активность.

Шаг 6: Анализ сетевого трафика
Здесь я обратила внимание на сетевой дамп, чтобы понять, как злоумышленник взаимодействовал с удаленными серверами и какими IP-адресами пользовался. Были выявлены IP 85.140.1.102 и 89.232.113.1, активно участвовавшие в атаках.
Атакующий IP 85.140.1.102: Брутфорс-атаки для доступа к пользователю admin и последующие команды для установки руткита.
Атакующий IP 89.232.113.1: Множественные попытки подключения к docker_admin с признаками брутфорса и SQL-инъекций через POST-запросы.
Кроме того, через GET-запросы злоумышленник загружал файлы с внешних серверов (например, diamorphine.ko и drop.sh), что указывало на дальнейшее развитие атаки.
Скриншоты: Подозрительные GET- и POST-запросы с IP атакующих и загружаемые вредоносные файлы.

Обнаруженные IP-адреса атакующих:
85.140.1.102 – IP, с которого были многочисленные попытки брутфорс-подключений к пользователю admin через нестандартный порт 22201. После успешной аутентификации злоумышленник сразу же переключался на root, чтобы выполнять команды с повышенными привилегиями.
89.232.113.1 – также пытался получить доступ к docker_admin, периодически превышая лимит попыток и снова пытаясь подключиться.


POST-запросы: Злоумышленники с IP 89.232.113.1 активно отправляли POST-запросы на адреса, связанные с /servlet/distributedCDE.php, что может указывать на попытки SQL-инъекций или использования других уязвимостей для взаимодействия с сервером.
GET-запросы:
85.140.1.102 использовал GET запросы, чтобы загрузить файлы с расширениями .ko, .sh, и .tar.gz с внешних серверов, что могло включать загрузку вредоносного ПО (например, diamorphine.ko).
Обнаружены подозрительные запросы на /bot, /drop.sh, и /dropper.sh, что может указывать на загрузку или выполнение скриптов для дальнейшей автоматизации атаки.

Найдена инъекция на атакуемый ресурс, через которую был вход в систему сайта

На данном скриншоте видно, что в параметре query передаются подозрительные команды, которые могут указывать на попытки SQL-инъекций и командной инъекции. Вот некоторые из них:

Видно множество запросов HTTP от адреса 85.140.1.102 на различные порты, что указывает на активное использование HTTP-протокола для взаимодействия с системой.

Попытка злоумышленника получить доступ к файлу /etc/passwd через уязвимость Directory Traversal. 

Получение этого файла позволило злоумышленнику узнать о существовании учетных записей и потенциально о пользователях, которые могут иметь привилегии.

На данном скриншоте видна последовательность запросов HTTP, отправленных с IP-адреса 89.232.113.1 на IP 10.90.90.116, которые включают SQL-инъекцию в параметрах URI.


drop.sh используется для развертывания руткита и запуска вредоносного бота, который может выполнять различные вредоносные действия. Рекомендуется удалить все загруженные файлы и временные папки, а также провести анализ системы на наличие других изменений и следов руткита.

Сервер отвечает с кодом ошибки 404 Not Found, что означает, что запрашиваемый файл отсутствует на сервере. 

Был использован веб-сканера уязвимостей Zap. На основании анализа логов и данных запроса, можно сделать вывод, что он был настроен некорректно. Не наблюдается никаких признаков успешного выполнения атакующих действий, таких как инъекции или попытки эксплуатации уязвимостей. 
Шаг 7: Удаление обнаруженного вредоносного ПО
После анализа временных файлов и скриптов я обнаружила файл drop.sh, который использовался для развертывания руткита diamorphine.ko и запуска вредоносного бота. Основной задачей было удалить этот скрипт и все связанные с ним компоненты, чтобы нейтрализовать угрозу.
Удаление загруженных файлов:
Во-первых, я вручную удалила временную папку /tmp/N3M3S1S_folder, в которой хранились файлы, связанные с вредоносным ПО.
Также я проверила наличие файла diamorphine.ko и удалили его из всех возможных директорий, где он мог быть загружен.
Удаление руткита:
Руткит diamorphine.ko был загружен в ядро для скрытия следов. Я использовала команду rmmod diamorphine для выгрузки его из ядра и очистила следы.
После этого я вручную проверила системные модули, чтобы убедиться, что руткит полностью удален.
Очищение cron-заданий:
Вредоносный скрипт avahi был настроен на автоматический запуск через cron при каждом перезапуске системы. Я удалила это задание из cron, проверила другие задания, чтобы убедиться в отсутствии других вредоносных скриптов.
Проверка файловой системы и логов:
Я провела финальную проверку всех подозрительных директорий и логов, чтобы убедиться, что файлы bot, drop.sh, и diamorphine.ko не оставили следов в системе.
Дополнительно проверила и восстановила логирование, чтобы система могла фиксировать все дальнейшие действия для предотвращения подобных атак в будущем.



Выводы
По результатам анализа, злоумышленник применял несколько техник для получения и закрепления доступа в системе. Эксплуатация старой версии GRUB, слабые пароли для SSH и использование руткита помогли ему скрыться. Было очевидно, что злоумышленник также понимал важность маскировки своих действий, включая очистку логов и автоматические задачи в Cron.

Рекомендации по восстановлению системы и повышению уровня защищенности
Обновление программного обеспечения: Установка последних версий GRUB, SSH и других уязвимых компонентов.
Ограничение доступа: Отключение root-доступа по SSH и настройка аутентификации через ключи.
Журналирование и резервное копирование логов: Настройка удаленного хранения логов.
Очистка Cron-заданий: Проверка на подозрительные задания и их удаление.
Мониторинг системы: Внедрение системы IDS для раннего оповещения о подозрительной активности.
Изоляция Docker: Ограничение прав доступа для контейнеров.

Заключение
Проведенный анализ позволил мне получить полное представление о действиях злоумышленника, включая использование брутфорса, SQL-инъекций и руткита. После удаления всех следов вредоносной активности, я предложила меры для усиления безопасности, чтобы предотвратить подобные инциденты в будущем.
